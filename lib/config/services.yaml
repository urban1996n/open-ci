services:
  _defaults:
    autowire: true
    autoconfigure: true
    public: false
    bind:
      $rootDir: '%application.root_dir%'

  pipeline_assembler:
    class: App\Pipeline\Assembler

  pipeline_schema_validator:
    class: App\Pipeline\SchemaValidator
    arguments: ['%env(SCHEMA_URL)%']

  pipeline_factory:
    class: App\Pipeline\PipelineFactory
    arguments: ['@pipeline_schema_validator', '@pipeline_assembler', '%env(PIPELINE_PATH)%']

  script_runner:
    class: App\Job\ScriptRunner

  pipeline_executor:
    class: App\Job\Executor
    arguments: ['@pipeline_factory', '@script_runner']

  amqp_connection:
    class: App\AMQP\Connection
    arguments: ['%env(AMQP_HOST)%', '%env(AMQP_PORT)%', '%env(AMQP_USER)%', '%env(AMQP_PASSWORD)%']

  logger_factory:
    class: App\Job\Logger\LoggerFactory

  runner_factory:
    class: App\Runner\Factory
    arguments: ['@pipeline_executor', '@logger_factory']

  runner_registry:
    class: App\Runner\Registry
    arguments: ['@runner_factory']

  pipeline_command:
    class: App\Command\RunPipelineCommand
    calls:
      - [setUpFactory, ['@runner_registry']]

  Application:
    class: Application
    arguments: [['@pipeline_command']]
    public: true

